@model IEnumerable<BTNHOMTKW.Models.DonHang>

@{
    ViewBag.Title = "Dashboard";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="h3 mb-1 text-primary"><i class="fas fa-tachometer-alt me-2"></i>Tổng quan</h2>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item active" aria-current="page">Báo cáo hoạt động kinh doanh</li>
            </ol>
        </nav>
    </div>
    <div class="text-muted small">
        <i class="far fa-clock me-1"></i> Cập nhật: @DateTime.Now.ToString("dd/MM/yyyy HH:mm")
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="card shadow-sm border-0 h-100 border-start border-4 border-primary">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-uppercase text-primary fw-bold small mb-1">Đơn hàng mới</div>
                        <div class="h3 mb-0 fw-bold text-gray-800">@ViewBag.DonHangMoi</div>
                        <small class="text-muted"><i class="fas fa-arrow-up text-success me-1"></i>Cần xử lý ngay</small>
                    </div>
                    <div class="bg-primary bg-opacity-10 p-3 rounded-circle text-primary">
                        <i class="fas fa-shopping-bag fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card shadow-sm border-0 h-100 border-start border-4 border-success">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-uppercase text-success fw-bold small mb-1">Doanh thu tháng</div>
                        <div class="h3 mb-0 fw-bold text-gray-800">@String.Format("{0:N0}", ViewBag.DoanhThuThang) <span class="fs-6">đ</span></div>
                        <small class="text-muted"><i class="far fa-calendar-alt me-1"></i>Tháng @DateTime.Now.Month/@DateTime.Now.Year</small>
                    </div>
                    <div class="bg-success bg-opacity-10 p-3 rounded-circle text-success">
                        <i class="fas fa-dollar-sign fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card shadow-sm border-0 h-100 border-start border-4 border-info">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-uppercase text-info fw-bold small mb-1">Khách hàng</div>
                        <div class="h3 mb-0 fw-bold text-gray-800">@ViewBag.SoKhachHang</div>
                        <small class="text-muted"><i class="fas fa-user-plus me-1"></i>Tổng thành viên</small>
                    </div>
                    <div class="bg-info bg-opacity-10 p-3 rounded-circle text-info">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-3 col-md-6">
        <div class="card shadow-sm border-0 h-100 border-start border-4 border-warning">
            <div class="card-body">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <div class="text-uppercase text-warning fw-bold small mb-1">Sắp hết hàng</div>
                        <div class="h3 mb-0 fw-bold text-gray-800">@ViewBag.SapHetHang</div>
                        <small class="text-muted text-danger fw-bold"><i class="fas fa-exclamation-triangle me-1"></i>Cần nhập thêm</small>
                    </div>
                    <div class="bg-warning bg-opacity-10 p-3 rounded-circle text-warning">
                        <i class="fas fa-box-open fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4 mb-4">
    <div class="col-xl-8 col-lg-7">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white py-3 d-flex flex-row align-items-center justify-content-between">
                <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-chart-line me-2"></i>Doanh thu năm @DateTime.Now.Year</h6>
            </div>
            <div class="card-body">
                <div class="chart-area" style="height: 320px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="col-xl-4 col-lg-5">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-primary"><i class="fas fa-chart-pie me-2"></i>Tỷ lệ đơn hàng</h6>
            </div>
            <div class="card-body">
                <div class="chart-pie pt-4 pb-2" style="height: 250px;">
                    <canvas id="orderStatusChart"></canvas>
                </div>
                <div class="mt-4 text-center small text-muted">
                    <i class="fas fa-info-circle me-1"></i> Tỷ lệ dựa trên toàn bộ lịch sử
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-8">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3 d-flex justify-content-between align-items-center">
                <h6 class="m-0 font-weight-bold text-dark"><i class="fas fa-shopping-cart me-2"></i>Đơn hàng gần đây</h6>
                <a href="@Url.Action("Index", "AdminDonHangs")" class="btn btn-sm btn-light">Xem tất cả</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover table-striped mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Mã ĐH</th>
                                <th>Khách hàng</th>
                                <th>Ngày đặt</th>
                                <th class="text-end">Tổng tiền</th>
                                <th class="text-center">Trạng thái</th>
                                <th class="text-center">Hành động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model)
                            {
                                <tr>
                                    <td class="ps-4 fw-bold text-primary">#@item.MaDonHang</td>
                                    <td>
                                        <div class="fw-bold text-dark">@item.KhachHang.HoTen</div>
                                    </td>
                                    <td>
                                        @item.NgayDat.ToString("dd/MM")
                                        <span class="text-muted small">@item.NgayDat.ToString("HH:mm")</span>
                                    </td>
                                    <td class="text-end fw-bold text-success">
                                        @String.Format("{0:N0}", item.ThanhTien)
                                    </td>
                                    <td class="text-center">
                                        @{
                                            var badgeColor = GetStatusBadgeClass(item.TrangThai);
                                            // Chuyển đổi class cũ sang class mới của Bootstrap 5 bg-opacity
                                            var bs5Class = "bg-secondary text-secondary";
                                            if (badgeColor.Contains("success")) { bs5Class = "bg-success text-success"; }
                                            else if (badgeColor.Contains("warning")) { bs5Class = "bg-warning text-warning"; }
                                            else if (badgeColor.Contains("info")) { bs5Class = "bg-info text-info"; }
                                            else if (badgeColor.Contains("danger")) { bs5Class = "bg-danger text-danger"; }
                                        }
                                        <span class="badge @bs5Class bg-opacity-10 border border-opacity-25 px-3 py-2">
                                            @item.TrangThai
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <a href="@Url.Action("Details", "AdminDonHangs", new { id = item.MaDonHang })"
                                           class="btn btn-sm btn-light text-primary border" title="Xem chi tiết">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white py-3">
                <h6 class="m-0 font-weight-bold text-dark"><i class="fas fa-crown me-2 text-warning"></i>Top sản phẩm bán chạy</h6>
            </div>
            <div class="card-body">
                <div id="topProductsList">
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="ms-2">Đang tải dữ liệu...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            loadChartData();
        });

        async function loadChartData() {
            try {
                const response = await fetch('@Url.Action("GetChartData", "AdminDashboard")');
                const data = await response.json();

                renderRevenueChart(data.doanhThuTheoThang);
                renderOrderStatusChart(data.trangThaiDonHang);
                renderTopProducts(data.topSanPham);
            } catch (error) {
                console.error("Lỗi tải dữ liệu:", error);
            }
        }

        function renderRevenueChart(data) {
            const ctx = document.getElementById('revenueChart').getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(78, 115, 223, 0.5)');
            gradient.addColorStop(1, 'rgba(78, 115, 223, 0.0)');

            const months = ['T1','T2','T3','T4','T5','T6','T7','T8','T9','T10','T11','T12'];
            const revenues = data.map(item => item.DoanhThu);

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Doanh thu',
                        data: revenues,
                        borderColor: '#4e73df',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointBackgroundColor: '#4e73df',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: '#4e73df',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) {
                                        label += new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { borderDash: [2, 2] },
                            ticks: {
                                callback: function(value) { return value.toLocaleString() + ' đ'; }
                            }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderOrderStatusChart(data) {
            const ctx = document.getElementById('orderStatusChart').getContext('2d');
            const statuses = data.map(item => item.TrangThai);
            const counts = data.map(item => item.SoLuong);
            const colors = ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'];

            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: statuses,
                    datasets: [{
                        data: counts,
                        backgroundColor: colors,
                        hoverBackgroundColor: colors,
                        hoverBorderColor: "rgba(234, 236, 244, 1)",
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 6 } }
                    },
                    cutout: '75%',
                }
            });
        }

        function renderTopProducts(data) {
            const container = document.getElementById('topProductsList');
            let html = '';
            if (data.length === 0) {
                html = '<div class="text-center text-muted py-3">Chưa có dữ liệu</div>';
            } else {
                data.forEach((product, index) => {
                    let badgeClass = 'bg-light text-secondary';
                    if (index === 0) badgeClass = 'bg-warning text-white';
                    else if (index === 1) badgeClass = 'bg-secondary text-white';
                    else if (index === 2) badgeClass = 'bg-white border text-dark';

                    html += `
                        <div class="d-flex align-items-center mb-3 pb-2 border-bottom">
                            <div class="me-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center shadow-sm ${badgeClass}"
                                     style="width: 32px; height: 32px; font-weight: bold;">
                                    ${index + 1}
                                </div>
                            </div>
                            <div class="flex-grow-1 overflow-hidden">
                                <div class="text-truncate fw-bold text-dark" title="${product.TenSanPham}">${product.TenSanPham}</div>
                                <div class="d-flex justify-content-between align-items-center mt-1">
                                    <small class="text-muted">Đã bán: <b class="text-primary">${product.SoLuongBan}</b></small>
                                    <small class="text-success fw-bold">${product.DoanhThu.toLocaleString()} đ</small>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            container.innerHTML = html;
        }
    </script>
}


@functions {
    public string GetStatusBadgeClass(string status)
    {
        switch (status)
        {
            case "Hoàn thành": return "success";
            case "Đang xử lý": return "warning";
            case "Chờ xác nhận": return "info";
            case "Đã hủy": return "danger";
            case "Đang giao": return "primary";
            default: return "secondary";
        }
    }
}
@section Styles
{
<style>
    .card {
        border-radius: 10px;
    }

    .bg-gradient-primary {
        background: linear-gradient(45deg, #4e73df, #224abe);
    }

    .chart-area {
        position: relative;
        width: 100%;
    }
</style>
}
@model IEnumerable<BTNHOMTKW.Models.GioHangItem>
@{
    ViewBag.Title = "Giỏ hàng";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@section Styles
{
    <style>
        /* CSS tùy chỉnh cho giỏ hàng */
        .cart-header {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .product-img-cart {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid #eee;
        }

        .btn-quantity {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50% !important;
        }

            .btn-quantity i {
                font-size: 0.85rem;
                line-height: 1;
                pointer-events: none;
            }

        .quantity-input {
            width: 56px !important;
            text-align: center;
            border: none !important;
            background: transparent;
            font-weight: 600;
            padding: 0.375rem 0 !important;
            height: 36px;
        }

        .fa-plus, .fa-minus {
            line-height: 1 !important;
        }

        .cart-summary {
            background: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 10px;
        }

        /* Vô hiệu hóa hiệu ứng hover card chỉ riêng trang giỏ hàng */
        .cart-page .card:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Căn giữa nội dung trong bảng */
        .table > :not(caption) > * > * {
            vertical-align: middle;
        }
    </style>
}

<div class="container py-5 cart-page">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-transparent p-0">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")" class="text-muted">Trang chủ</a></li>
            <li class="breadcrumb-item active text-dark" aria-current="page">Giỏ hàng của bạn</li>
        </ol>
    </nav>

    @if (Model != null && Model.Any())
    {
        <div class="row">
            <!-- CỘT TRÁI: DANH SÁCH SẢN PHẨM -->
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-borderless align-middle mb-0">
                                <thead class="cart-header text-muted small text-uppercase">
                                    <tr>
                                        <th class="ps-4 py-3">Sản phẩm</th>
                                        <th class="text-center py-3">Số lượng</th>
                                        <th class="text-end pe-4 py-3">Thành tiền</th>
                                        <th class="text-center py-3" style="width: 80px;">Hành động</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model)
                                    {
                                        <tr class="border-bottom" id="row-@item.MaSP-@item.TenSize-@item.TenMau">
                                            <!-- Ảnh & Tên -->
                                            <td class="ps-4 py-3">
                                                <div class="d-flex align-items-center">
                                                    <a href="@Url.Action("Detail", "Product", new { id = item.MaSP })">
                                                        <img src="@item.SanPham.HinhAnhChinh" class="product-img-cart me-3" alt="@item.SanPham.TenSP" />
                                                    </a>
                                                    <div>
                                                        <a href="@Url.Action("Detail", "Product", new { id = item.MaSP })" class="text-dark text-decoration-none fw-bold d-block">
                                                            @item.SanPham.TenSP
                                                        </a>
                                                        <small class="text-muted">
                                                            Size: <span class="text-dark fw-bold">@item.TenSize</span> |
                                                            Màu: <span class="text-dark fw-bold">@item.TenMau</span>
                                                        </small>
                                                        <div class="small text-muted mt-1">
                                                            Đơn giá: <span class="text-dark fw-bold">@item.SanPham.GiaBan.ToString("#,##0") đ</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </td>

                                            <!-- Số lượng -->
                                            <td class="text-center">
                                                <div class="d-flex align-items-center justify-content-center gap-2">
                                                    <button class="btn btn-outline-secondary btn-quantity btn-update shadow-sm" type="button" data-action="decrease">
                                                        <i class="fas fa-minus"></i>
                                                    </button>

                                                    <input type="number"
                                                           class="form-control quantity-input fw-bold text-center"
                                                           value="@item.SoLuong" min="1"
                                                           data-id="@item.MaSP"
                                                           data-size="@item.TenSize"
                                                           data-color="@item.TenMau" />

                                                    <button class="btn btn-outline-secondary btn-quantity btn-update shadow-sm" type="button" data-action="increase">
                                                        <i class="fas fa-plus"></i>
                                                    </button>
                                                </div>
                                            </td>

                                            <!-- Thành tiền -->
                                            <td class="text-end pe-4 fw-bold text-dark item-total">
                                                @((item.SoLuong * item.SanPham.GiaBan).ToString("#,##0")) đ
                                            </td>

                                            <!-- Xóa -->
                                            <td class="text-center">
                                                <a href="@Url.Action("Remove", new { maSP = item.MaSP, size = item.TenSize, mau = item.TenMau })"
                                                   class="text-danger p-2"
                                                   onclick="return confirm('Bạn muốn xóa sản phẩm này khỏi giỏ hàng?')"
                                                   title="Xóa sản phẩm">
                                                    <i class="fas fa-trash-alt"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between">
                    <a href="@Url.Action("Index", "Product")" class="btn btn-outline-dark rounded-pill px-4">
                        <i class="fas fa-arrow-left me-2"></i> Tiếp tục mua sắm
                    </a>
                </div>
            </div>

            <!-- CỘT PHẢI: TỔNG KẾT ĐƠN HÀNG -->
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm cart-summary p-4">
                    <h5 class="fw-bold mb-4">Cộng giỏ hàng</h5>

                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-muted">Tạm tính:</span>
                        <span class="fw-bold" id="sub-total">@Model.Sum(x => x.SoLuong * x.SanPham.GiaBan).ToString("#,##0") đ</span>
                    </div>

                    <hr />

                    <div class="d-flex justify-content-between mb-4">
                        <span class="fw-bold h5">Tổng cộng:</span>
                        <span class="fw-bold h4 text-danger" id="cart-total">@Model.Sum(x => x.SoLuong * x.SanPham.GiaBan).ToString("#,##0") đ</span>
                    </div>

                    <a href="@Url.Action("Checkout", "Cart")" class="btn btn-dark btn-lg w-100 rounded-pill shadow fw-bold py-3">
                        TIẾN HÀNH THANH TOÁN
                    </a>

                    <div class="text-center mt-3">
                        <small class="text-muted"><i class="fas fa-shield-alt me-1"></i> Bảo mật thanh toán 100%</small>
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <div class="mb-4">
                <img src="~/Content/images/banner/cart.png" alt="Empty Cart" style="width: 150px; opacity: 0.5;">
            </div>
            <h3 class="fw-bold text-dark">Giỏ hàng của bạn đang trống!</h3>
            <p class="text-muted mb-4">Hãy chọn thêm sản phẩm để mua sắm nhé.</p>
            <a href="@Url.Action("Index", "Product")" class="btn btn-primary btn-lg rounded-pill px-5 shadow">
                MUA NGAY
            </a>
        </div>
    }
</div>

@section scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // 1. Bắt sự kiện click cho nút tăng/giảm
            document.querySelectorAll(".btn-update").forEach(function (btn) {
                btn.addEventListener("click", function () {
                    var container = btn.closest(".d-flex");
                    var input = container.querySelector("input.quantity-input");
                    var currentVal = parseInt(input.value) || 0;
                    var action = btn.getAttribute("data-action");

                    if (action === "increase") {
                        input.value = currentVal + 1;
                    } else if (action === "decrease") {
                        input.value = Math.max(1, currentVal - 1);
                    }

                    // Kích hoạt sự kiện change để gọi Ajax
                    input.dispatchEvent(new Event("change"));
                });
            });

            // 2. Bắt sự kiện change cho input số lượng
            document.querySelectorAll(".quantity-input").forEach(function (input) {
                input.addEventListener("change", function () {
                    var maSP = input.getAttribute("data-id");
                    var size = input.getAttribute("data-size");
                    var mau = input.getAttribute("data-color");
                    var newQty = parseInt(input.value);

                    if (isNaN(newQty) || newQty < 1) {
                        newQty = 1;
                        input.value = 1;
                    }

                    input.disabled = true;
                    input.style.opacity = "0.6";

                    // Gửi Ajax bằng fetch
                    fetch("/Cart/UpdateQuantity", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/x-www-form-urlencoded"
                        },
                        body: `maSP=${encodeURIComponent(maSP)}&size=${encodeURIComponent(size)}&mau=${encodeURIComponent(mau)}&newQuantity=${newQty}`
                    })
                        .then(response => response.json())
                        .then(res => {
                            input.disabled = false;
                            input.style.opacity = "1";

                            if (res.success) {
                                // Cập nhật thành tiền dòng
                                var row = input.closest("tr");
                                row.querySelector(".item-total").textContent = res.itemTotal + " đ";

                                // Cập nhật tổng tiền giỏ hàng
                                document.getElementById("cart-total").textContent = res.totalCart + " đ";
                                document.getElementById("sub-total").textContent = res.totalCart + " đ";
                            } else {
                                alert(res.message || "Có lỗi xảy ra khi cập nhật số lượng.");
                            }
                        })
                        .catch(() => {
                            alert("Lỗi kết nối!");
                            input.disabled = false;
                            input.style.opacity = "1";
                        });
                });
            });
        });
    </script>
}

@model IEnumerable<BTNHOMTKW.Models.SanPham>
@{
    ViewBag.Title = ViewBag.CategoryName;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-4 mb-5">
    <div class="row">
        <!-- Cột trái: Bộ lọc -->
        <div class="col-md-3">

            <!-- Tìm kiếm -->
            <div class="card mb-3">
                <div class="card-header fw-bold text-uppercase">Tìm kiếm</div>
                <div class="card-body p-3">
                    <form action="@Url.Action("Index", "Product")" method="get">
                        <div class="input-group">
                            <span class="input-group-text bg-light"><i class="fa fa-search text-muted"></i></span>
                            <input type="text" name="searchString" class="form-control form-control-sm" placeholder="Nhập tên SP..." value="@ViewBag.Keyword">
                            <button class="btn btn-sm btn-primary" type="submit">Tìm</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Danh mục -->
            <div class="card mb-3">
                <div class="card-header fw-bold text-uppercase">
                    <i class="fa fa-list-ul me-2"></i> Danh mục
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item p-2">
                        <a href="@Url.Action("Index", "Product")" class="text-dark fw-bold">
                            <i class="fa fa-angle-right"></i> Tất cả sản phẩm
                        </a>
                    </li>

                    @{
                        var dbContext = new BTNHOMTKW.Models.DoAn_ShopEntities();
                        var danhMucs = dbContext.DanhMucs.ToList();
                        var parents = danhMucs.Where(x => x.ParentDM == null).ToList();
                    }

                    @foreach (var parent in parents)
                    {
                        <li class="list-group-item p-2 bg-light">
                            <a href="@Url.Action("Index", "Product", new { slug = parent.Slug })" class="text-dark fw-bold">
                                @parent.TenDM
                            </a>
                        </li>

                        var childs = danhMucs.Where(x => x.ParentDM == parent.TenDM).ToList();
                        if (childs.Count > 0)
                        {
                            foreach (var child in childs)
                            {
                                <li class="list-group-item p-1 border-0 ps-4">
                                    <a href="@Url.Action("Index", "Product", new { slug = child.Slug })"
                                       class="text-muted @(Request.QueryString["slug"] == child.Slug ? "text-primary fw-bold" : "")">
                                        <i class="fa fa-caret-right small me-1"></i> @child.TenDM
                                    </a>
                                </li>
                            }
                        }
                    }
                </ul>
            </div>

            <!-- Khoảng giá -->
            <div class="card mb-3">
                <div class="card-header fw-bold text-uppercase">Khoảng giá</div>
                <div class="card-body p-3">
                    <form action="@Url.Action("Index", "Product")" method="get">
                        @if (ViewBag.Keyword != null)
                        {<input type="hidden" name="searchString" value="@ViewBag.Keyword" />}
                        @if (Request.QueryString["slug"] != null)
                        {<input type="hidden" name="slug" value="@Request.QueryString["slug"]" />}

                        <div class="form-check mb-2">
                            <input type="radio" id="priceAll" name="priceRange" value="" class="form-check-input" @(ViewBag.PriceRange == null ? "checked" : "")>
                            <label class="form-check-label" for="priceAll">Tất cả</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="radio" id="price1" name="priceRange" value="1" class="form-check-input" @(ViewBag.PriceRange == "1" ? "checked" : "")>
                            <label class="form-check-label" for="price1">Dưới 200k</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="radio" id="price2" name="priceRange" value="2" class="form-check-input" @(ViewBag.PriceRange == "2" ? "checked" : "")>
                            <label class="form-check-label" for="price2">200k - 500k</label>
                        </div>
                        <div class="form-check mb-2">
                            <input type="radio" id="price3" name="priceRange" value="3" class="form-check-input" @(ViewBag.PriceRange == "3" ? "checked" : "")>
                            <label class="form-check-label" for="price3">Trên 500k</label>
                        </div>

                        <button type="submit" class="btn btn-sm btn-dark w-100 mt-3">Áp dụng</button>
                    </form>
                </div>
            </div>

        </div>

        <!-- Cột phải: Danh sách sản phẩm -->
        <div class="col-md-9">
            <div class="d-flex justify-content-between align-items-center mb-3 bg-light p-2 rounded">
                <span class="fw-bold text-muted ms-2">Hiển thị @Model.Count() sản phẩm</span>

                <form class="d-flex align-items-center">
                    <label class="me-2 small">Sắp xếp:</label>
                    <select class="form-select form-select-sm" onchange="location = this.value;">
                        <option value="@Url.Action("Index", "Product", new { sortOrder = "newest", slug = Request.QueryString["slug"], priceRange = ViewBag.PriceRange })" @(ViewBag.SortOrder == "newest" ? "selected" : "")>Mới nhất</option>
                        <option value="@Url.Action("Index", "Product", new { sortOrder = "price_asc", slug = Request.QueryString["slug"], priceRange = ViewBag.PriceRange })" @(ViewBag.SortOrder == "price_asc" ? "selected" : "")>Giá tăng dần</option>
                        <option value="@Url.Action("Index", "Product", new { sortOrder = "price_desc", slug = Request.QueryString["slug"], priceRange = ViewBag.PriceRange })" @(ViewBag.SortOrder == "price_desc" ? "selected" : "")>Giá giảm dần</option>
                    </select>
                </form>
            </div>

            @if (Model.Count() == 0)
            {
                <div class="alert alert-warning text-center">Không có sản phẩm nào phù hợp.</div>
            }
            else
            {
                <div class="row">
                    @foreach (var item in Model)
                    {
                        <div class="col-lg-4 col-md-6 mb-4">
                            <div class="card h-100 shadow-sm">
                                <a href="@Url.Action("Detail", "Product", new { id = item.MaSP })">
                                    <img class="card-img-top" src="@item.HinhAnhChinh" style="height: 200px; object-fit: cover;">
                                </a>
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <a href="@Url.Action("Detail", "Product", new { id = item.MaSP })" class="text-dark">@item.TenSP</a>
                                    </h6>
                                    <p class="text-danger fw-bold">@item.GiaBan.ToString("#,##0") đ</p>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

@model BTNHOMTKW.Models.KhachHang
@{
    ViewBag.Title = "Hồ sơ của tôi";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container mt-5 mb-5">
    <div class="row">
        <!-- Thông tin bên trái -->
        <div class="col-md-4 mb-4">
            <div class="card shadow-sm border-0 text-center p-4">
                <div class="mb-3">
                    <img src="https://ui-avatars.com/api/?name=@Model.HoTen&background=0D8ABC&color=fff&size=128" class="rounded-circle" />
                </div>
                <h5 class="fw-bold">@Model.HoTen</h5>
                <p class="text-muted">@Model.TaiKhoanEmail</p>
                <a href="@Url.Action("Logout", "Account")" class="btn btn-danger btn-sm mt-2">
                    <i class="fa fa-sign-out-alt"></i> Đăng xuất
                </a>
            </div>
        </div>

        <!-- Nội dung bên phải -->
        <div class="col-md-8">
            @if (TempData["Success"] != null)
            {<div class="alert alert-success">@TempData["Success"]</div>}
            @if (TempData["Error"] != null)
            {<div class="alert alert-danger">@TempData["Error"]</div>}

            <div class="card shadow-sm border-0">
                <div class="card-header bg-white">
                    <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active fw-bold" id="info-tab" data-bs-toggle="tab" href="#info" role="tab">Thông tin cá nhân</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-bold" id="address-tab" data-bs-toggle="tab" href="#address" role="tab">Sổ địa chỉ</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link fw-bold" id="order-tab" data-bs-toggle="tab" href="#order" role="tab">Lịch sử đơn hàng</a>
                        </li>
                    </ul>
                </div>
                <div class="card-body">
                    <div class="tab-content" id="myTabContent">

                        <!-- Tab thông tin cá nhân -->
                        <div class="tab-pane fade show active" id="info" role="tabpanel">
                            @using (Html.BeginForm("UpdateProfile", "Account", FormMethod.Post))
                            {
                                @Html.AntiForgeryToken()
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">Email:</label>
                                    <div class="col-sm-9">
                                        <input type="text" class="form-control-plaintext" value="@Model.TaiKhoanEmail" readonly>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">Họ và tên:</label>
                                    <div class="col-sm-9">
                                        <input type="text" name="hoTen" class="form-control" value="@Model.HoTen" required>
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">Số điện thoại:</label>
                                    <div class="col-sm-9">
                                        <input type="text" name="sdt" class="form-control" value="@Model.SDT">
                                    </div>
                                </div>
                                <div class="mb-3 row">
                                    <label class="col-sm-3 col-form-label">Ngày sinh:</label>
                                    <div class="col-sm-9">
                                        <input type="date" name="ngaySinh" class="form-control"
                                               value="@(Model.NgaySinh.HasValue ? Model.NgaySinh.Value.ToString("yyyy-MM-dd") : "")">
                                    </div>
                                </div>
                                <div class="text-end">
                                    <button type="submit" class="btn btn-primary">Lưu thay đổi</button>
                                </div>
                            }
                        </div>

                        <!-- Tab sổ địa chỉ -->
                        <div class="tab-pane fade" id="address" role="tabpanel">
                            <div class="card bg-light mb-4 border-0">
                                <div class="card-body">
                                    <h6 class="fw-bold mb-3">Thêm địa chỉ mới</h6>
                                    @using (Html.BeginForm("AddAddress", "Account", FormMethod.Post))
                                    {
                                        @Html.AntiForgeryToken()
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <input type="text" name="nguoiNhan" class="form-control form-control-sm" placeholder="Tên người nhận" required>
                                            </div>
                                            <div class="col-md-6">
                                                <input type="text" name="sdtNhan" class="form-control form-control-sm" placeholder="SĐT người nhận" required>
                                            </div>
                                            <div class="col-md-12">
                                                <input type="text" name="diaChi" class="form-control form-control-sm" placeholder="Địa chỉ cụ thể (Số nhà, đường, phường, quận...)" required>
                                            </div>
                                            <div class="col-md-12 d-flex justify-content-between align-items-center">
                                                <div class="form-check">
                                                    <input type="checkbox" class="form-check-input" id="macDinh" name="macDinh" value="true">
                                                    <label class="form-check-label small" for="macDinh">Đặt làm mặc định</label>
                                                </div>
                                                <button type="submit" class="btn btn-sm btn-success">Thêm mới</button>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            @if (Model.DiaChis != null && Model.DiaChis.Count > 0)
                            {
                                foreach (var item in Model.DiaChis.OrderByDescending(x => x.MacDinh))
                                {
                                    <div class="border rounded p-3 mb-3 position-relative @(item.MacDinh ? "border-primary bg-white" : "bg-light")">
                                        @if (item.MacDinh)
                                        {
                                            <span class="badge bg-primary position-absolute" style="top: 10px; right: 10px;">Mặc định</span>
                                        }
                                        else
                                        {
                                            <div class="position-absolute" style="top: 10px; right: 10px;">
                                                <a href="@Url.Action("SetDefaultAddress", "Account", new { diaChiChiTiet = item.DiaChiChiTiet })" class="btn btn-link btn-sm p-0 text-info small">Thiết lập mặc định</a>
                                                <span class="text-muted mx-1">|</span>
                                                <a href="@Url.Action("DeleteAddress", "Account", new { diaChiChiTiet = item.DiaChiChiTiet })" class="btn btn-link btn-sm p-0 text-danger small" onclick="return confirm('Bạn có chắc muốn xóa?')">Xóa</a>
                                            </div>
                                        }

                                        <h6 class="fw-bold mb-1">@item.HoTenNhan <span class="fw-normal text-muted ms-2">(@item.SDTNhan)</span></h6>
                                        <p class="mb-0 text-muted small">@item.DiaChiChiTiet</p>
                                    </div>
                                }
                            }
                            else
                            {
                                <p class="text-center text-muted">Chưa có địa chỉ nào.</p>
                            }
                        </div>

                        <!-- Tab lịch sử đơn hàng -->
                        <div class="tab-pane fade" id="order" role="tabpanel">
                            @if (Model.DonHangs != null && Model.DonHangs.Count > 0)
                            {
                                <table class="table table-sm table-hover">
                                    <thead>
                                        <tr>
                                            <th>Mã ĐH</th>
                                            <th>Ngày đặt</th>
                                            <th>Tổng tiền</th>
                                            <th>Trạng thái</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var dh in Model.DonHangs.OrderByDescending(x => x.NgayDat))
                                        {
                                            <tr>
                                                <td>@dh.MaDonHang</td>
                                                <td>@dh.NgayDat.ToString("dd/MM/yyyy")</td>
                                                <td>@dh.TongTien.ToString("#,##0") đ</td>
                                                <td><span class="badge bg-info">@dh.TrangThai</span></td>
                                                <td><a href="@Url.Action("OrderDetail", "Account", new { id = dh.MaDonHang })" class="btn btn-sm btn-outline-primary">Xem</a></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <p class="text-center text-muted">Bạn chưa có đơn hàng nào.</p>
                                <div class="text-center">
                                    <a href="@Url.Action("Index", "Home")" class="btn btn-primary">Mua sắm ngay</a>
                                </div>
                            }
                        </div>

                    </div> <!-- tab-content -->
                </div> <!-- card-body -->
            </div> <!-- card -->
        </div> <!-- col-md-8 -->
    </div> <!-- row -->
</div> <!-- container -->
